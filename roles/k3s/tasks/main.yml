# uninstall firewall
- name: Remote ufw firewall
  apt:
    name: ufw
    state: absent
    purge: true

## fix ulimit for k8s
- name: limits
  copy:
    src: files/limits_k8s.conf
    dest: '/etc/security/limits.d/k8s.conf'
    mode: '0644'

## fix multipathd
- name: Multipathd config
  copy:
    src: files/multipath.conf
    dest: '/etc/multipath.conf'
    mode: '0644'

- name: Fix multipathd
  systemd_service:
    name: multipathd
    enabled: true
    state: restarted

## install k3s
- name: Install k3s
  shell: curl -fL https://get.k3s.io | INSTALL_K3S_VERSION="v1.29.2+k3s1" K3S_KUBECONFIG_MODE="640" INSTALL_K3S_EXEC="server --cluster-cidr=10.12.0.0/24 --disable-network-policy --flannel-backend=none --disable traefik --disable local-storage --disable metrics-server" sh -

- name: allow sudoer access to k3s config
  file:
    path: /etc/rancher/k3s/k3s.yaml
    owner: root
    group: sudo

## shutdown helper
- name: k3s shutdown helper
  copy:
    src: 'files/k3s-shutdown.service'
    dest: '/etc/systemd/system/k3s-shutdown.service'
    mode: '0644'

- name: Start k3s shutdown helper
  systemd_service:
    name: k3s-shutdown.service
    enabled: true
    daemon_reload: true
